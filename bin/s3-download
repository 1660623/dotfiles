#!/usr/bin/env ruby
# rubocop:disable FileName

# Downloads all matching files in an S3 bucket.

require 'aws-sdk'
require 'fileutils'
require 'logger'
require 'ruby-progressbar'
require 'trollop'
require 'yaml'

logger = Logger.new(STDOUT)
logger.level = Logger::WARN

opts = Trollop.options do
  banner <<-EOS
Downloads all matching files in an S3 bucket.

Usage:
    s3-download [options] <bucket name> [mask]

where [options] are:
  EOS

  opt :config, 'Path to YAML file containing the AWS configuration', type: :string
  opt :debug, 'Outputs debug logging'
end

logger.level = Logger::DEBUG if opts[:debug]

bucket_name = ARGV[0]
mask = ARGV[1] || '*'

logger.debug "Bucket name: #{bucket_name}"
logger.debug "Mask: #{mask}"

config = YAML.load_file(opts[:config])
logger.debug 'AWS Creds --'
logger.debug "  Access Key: #{config['access_key']}"
logger.debug "  Secret Key: #{config['secret_key']}"

aws_config = AWS.config(config)
logger.debug 'AWS Config --'
logger.debug "  Access Key: #{aws_config.access_key_id}"
logger.debug "  Secret Key: #{aws_config.secret_access_key}"
logger.debug "  Region    : #{aws_config.region}"

# Get the bucket information
s3 = AWS::S3.new
bucket = s3.buckets[bucket_name]

total_bar = ProgressBar.create(title: 'Total', total: bucket.objects.count, format: '%t: |%B| %E')

# Download each matching object
bucket.objects.each do |object|
  total_bar.increment
  total_bar.log object.key
  next unless File.fnmatch?(mask, object.key)
  next if object.key.end_with?('/')

  FileUtils.mkdir_p(File.dirname(object.key))
  File.open(object.key, 'wb') do |file|
    bucket.objects[object.key].read do |chunk|
      file.write(chunk)
    end
  end
end

total_bar.finish
