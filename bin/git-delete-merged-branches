#!/usr/bin/env ruby

require 'optparse'

# Original inspiration from:
# https://gist.github.com/bxt/566fd7de151bf73a937d

def prompt(*args)
  print(*args)
  gets
end

options = {}
OptionParser.new do |opts|
  opts.banner = 'Usage: git delete-merged-branches [options]'

  opts.on('-bBRANCH', '--branch BRANCH', 'Branch to check for being merged into') do |b|
    options[:branch] = b
  end

  opts.on('-h', '--help', 'Show this help information') do |h|
    puts opts
    exit
  end
end.parse!

main = options[:branch] || 'master'
branches = `git branch --merged #{main} | grep -v -e 'master\\|staging\\|development\\|\\*'`

if branches.strip.empty?
  puts "No merged branches to delete"
  exit 0
end

puts "Branches merged into #{main}"
puts branches
puts

answer = prompt('Delete these branches (y/N)? ')

if answer.strip! != 'y'
  puts "Aborting"
  exit 0
end

`echo #{branches} | xargs -n 1 git branch -d`
